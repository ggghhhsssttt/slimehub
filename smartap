--SMART AP V6 PROBABLY FINAL CUZ ITS GOATED
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local STEAL_ANIM_ID = "rbxassetid://71186871415348"


if getgenv().__SMART_AP_LOADED__ then return end
getgenv().__SMART_AP_LOADED__ = true

-- =========================
-- COMMAND DATA
-- =========================
local COMMANDS = {
	rocket = 120,
	ragdoll = 30,
	balloon = 30,
	inverse = 60,
	jail = 60,
	tiny = 60,
	jumpscare = 60,
	morph = 60,
}

local lastUsed = {}
local enabledCommands = {}
for cmd in pairs(COMMANDS) do
	lastUsed[cmd] = 0
	enabledCommands[cmd] = true
end

-- =========================
-- GUI SETUP
-- =========================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SMART_AP_GUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = CoreGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.fromOffset(340, 520)
Frame.Position = UDim2.fromOffset(140, 160)
Frame.BackgroundColor3 = Color3.fromRGB(18,18,18)
Frame.Parent = ScreenGui
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0,12)

local TopBar = Instance.new("Frame")
TopBar.Size = UDim2.new(1,0,0,36)
TopBar.BackgroundColor3 = Color3.fromRGB(28,28,28)
TopBar.Parent = Frame
Instance.new("UICorner", TopBar).CornerRadius = UDim.new(0,12)

-- DRAGGING LOGIC
do
	local dragging = false
	local dragStart
	local startPos

	TopBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = input.Position
			startPos = Frame.Position
		end
	end)

	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = input.Position - dragStart
			Frame.Position = UDim2.fromOffset(
				startPos.X.Offset + delta.X,
				startPos.Y.Offset + delta.Y
			)
		end
	end)
end




local Title = Instance.new("TextLabel")
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1,-160,1,0)
Title.Position = UDim2.fromOffset(12,0)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextColor3 = Color3.fromRGB(235,235,235)
Title.Text = "SMART AP"
Title.Parent = TopBar

-- SPAM ALL TOGGLE
local SpamAll = false
local SpamBtn = Instance.new("TextButton")
SpamBtn.Size = UDim2.fromOffset(110,26)
SpamBtn.Position = UDim2.new(1,-116,0,5)
SpamBtn.Font = Enum.Font.GothamBold
SpamBtn.TextSize = 13
SpamBtn.TextColor3 = Color3.fromRGB(255,255,255)
SpamBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
SpamBtn.Text = "SPAM ALL: OFF"
SpamBtn.Parent = TopBar
Instance.new("UICorner", SpamBtn).CornerRadius = UDim.new(0,8)

SpamBtn.MouseButton1Click:Connect(function()
	SpamAll = not SpamAll
	SpamBtn.Text = "SPAM ALL: "..(SpamAll and "ON" or "OFF")
	SpamBtn.BackgroundColor3 = SpamAll and Color3.fromRGB(180,60,60) or Color3.fromRGB(60,60,60)
end)

-- REFRESH BUTTON
local RefreshBtn = Instance.new("TextButton")
RefreshBtn.Size = UDim2.fromOffset(90, 26)
RefreshBtn.Position = UDim2.new(1, -212, 0, 5) -- next to SPAM ALL
RefreshBtn.Font = Enum.Font.GothamBold
RefreshBtn.TextSize = 13
RefreshBtn.TextColor3 = Color3.fromRGB(255,255,255)
RefreshBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
RefreshBtn.Text = "REFRESH"
RefreshBtn.Parent = TopBar
Instance.new("UICorner", RefreshBtn).CornerRadius = UDim.new(0,8)

RefreshBtn.MouseButton1Click:Connect(function()
	refreshPlayers()
end)


-- =========================
-- PLAYER LIST
-- =========================
local Holder = Instance.new("Frame")
Holder.BackgroundTransparency = 1
Holder.Size = UDim2.new(1,-16,1,-200)
Holder.Position = UDim2.fromOffset(8,44)
Holder.Parent = Frame

local Scrolling = Instance.new("ScrollingFrame")
Scrolling.BackgroundTransparency = 1
Scrolling.BorderSizePixel = 0
Scrolling.ScrollBarThickness = 6
Scrolling.Size = UDim2.new(1,0,1,0)
Scrolling.Parent = Holder

local UIList = Instance.new("UIListLayout", Scrolling)
UIList.Padding = UDim.new(0,6)

-- =========================
-- COOLDOWNS + TOGGLES
-- =========================
local CooldownsFrame = Instance.new("Frame")
CooldownsFrame.Size = UDim2.new(1,-16,0,150)
CooldownsFrame.Position = UDim2.fromOffset(8, Frame.Size.Y.Offset - 156)
CooldownsFrame.BackgroundTransparency = 1
CooldownsFrame.Parent = Frame

local cooldownLabels = {}
local toggleButtons = {}

local x, y = 0, 0
for cmd, cd in pairs(COMMANDS) do
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.fromOffset(160,20)
	btn.Position = UDim2.fromOffset(x,y)
	btn.BackgroundTransparency = 1
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 14
	btn.TextXAlignment = Enum.TextXAlignment.Left
	btn.TextColor3 = Color3.fromRGB(235,235,235)
	btn.Text = "â˜‘ "..cmd..": 0s"
	btn.Parent = CooldownsFrame

	btn.MouseButton1Click:Connect(function()
		enabledCommands[cmd] = not enabledCommands[cmd]
		btn.Text = (enabledCommands[cmd] and "â˜‘ " or "â˜ ")..cmd..": "..btn.Text:match("(%d+s)") 
	end)

	cooldownLabels[cmd] = btn
	toggleButtons[cmd] = btn

	x += 170
	if x >= 320 then x = 0 y += 22 end
end

-- =========================
-- REMOTE
-- =========================
local function fireCommand(player, cmd)
	local re = ReplicatedStorage:FindFirstChild("Packages")
	if not re then return end
	re = re:FindFirstChild("Net")
	if not re then return end
	re = re:FindFirstChild("RE/AdminPanelService/ExecuteCommand")
	if re then
		pcall(function()
			re:FireServer(player, cmd)
		end)
	end
end

-- =========================
-- EXECUTION LOGIC
-- =========================
local function executeOnPlayer(player)
	if SpamAll then
		for cmd in pairs(COMMANDS) do
			fireCommand(player, cmd)
		end
	else
		local available = {}
		local now = os.clock()
		for cmd, cd in pairs(COMMANDS) do
			if enabledCommands[cmd] and (now - lastUsed[cmd] >= cd) then
				table.insert(available, cmd)
			end
		end
		if #available == 0 then
			for cmd in pairs(COMMANDS) do
				if enabledCommands[cmd] then
					table.insert(available, cmd)
				end
			end
		end
		if #available == 0 then return end
		fireCommand(player, available[math.random(#available)])
	end
end

-- =========================
-- OWNER DETECTION
-- =========================
local function getNearbyPlotOwner()
	local char = LocalPlayer.Character
	local hrp = char and char:FindFirstChild("HumanoidRootPart")
	if not hrp then return nil end

	local plots = Workspace:FindFirstChild("Plots")
	if not plots then return nil end

	for _, plot in ipairs(plots:GetChildren()) do
		local sign = plot:FindFirstChild("PlotSign", true)
		if sign and sign:IsA("BasePart") then
			if (sign.Position - hrp.Position).Magnitude <= 25 then
				local gui = sign:FindFirstChildWhichIsA("SurfaceGui", true)
				if gui and gui:FindFirstChild("Frame") and gui.Frame:FindFirstChild("TextLabel") then
					local text = gui.Frame.TextLabel.Text
					local display = text:match("^(.-)'s Base")
					return display
				end
			end
		end
	end
end

-- =========================
-- PLAYER BUTTON
-- =========================
local playerButtons = {}

local function createPlayerButton(player)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1,-6,0,36)
	btn.BackgroundColor3 = Color3.fromRGB(38,38,38)
	btn.Text = ""
	btn.Parent = Scrolling
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)

	local icon = Instance.new("ImageLabel")
	icon.Size = UDim2.fromOffset(28,28)
	icon.Position = UDim2.fromOffset(4,4)
	icon.BackgroundTransparency = 1
	icon.Image = Players:GetUserThumbnailAsync(player.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size48x48)
	icon.Parent = btn

	local name = Instance.new("TextLabel")
	name.BackgroundTransparency = 1
	name.Position = UDim2.fromOffset(38,0)
	name.Size = UDim2.new(1,-40,1,0)
	name.Font = Enum.Font.Gotham
	name.TextSize = 14
	name.TextXAlignment = Enum.TextXAlignment.Left
	name.TextColor3 = Color3.fromRGB(235,235,235)
	name.Text = player.DisplayName.." ("..player.Name..")"
	name.Parent = btn

	local ownerTag = Instance.new("TextLabel")
	ownerTag.BackgroundTransparency = 1
	ownerTag.Position = UDim2.new(1,-80,0,10)
	ownerTag.Size = UDim2.fromOffset(76,16)
	ownerTag.Font = Enum.Font.GothamBold
	ownerTag.TextSize = 12
	ownerTag.TextColor3 = Color3.fromRGB(255,215,0)
	ownerTag.Text = "â­OWNERâ­"
	ownerTag.Visible = false
	ownerTag.Parent = btn

	btn.MouseButton1Click:Connect(function()
		executeOnPlayer(player)
	end)

	playerButtons[player] = ownerTag
end

local function refreshPlayers()
	for _,c in ipairs(Scrolling:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end
	playerButtons = {}
	for _,p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			createPlayerButton(p)
		end
	end
end

Players.PlayerAdded:Connect(refreshPlayers)
Players.PlayerRemoving:Connect(refreshPlayers)
refreshPlayers()

-- =========================
-- NOTIFICATION LISTENER
-- =========================
task.spawn(function()
	local notif = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("Notification"):WaitForChild("Notification")
	notif.ChildAdded:Connect(function(child)
		if not child:IsA("TextLabel") then return end
		local cmd = child.Text:match('executed%s+"(.-)"')
		if cmd and COMMANDS[cmd] then
			lastUsed[cmd] = os.clock()
		end
	end)
end)


local function isPlayerStealing(player)
	local char = player.Character
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if not hum then return false end

	for _, track in ipairs(hum:GetPlayingAnimationTracks()) do
		if track.Animation and track.Animation.AnimationId == STEAL_ANIM_ID then
			return true
		end
	end
	return false
end


-- =========================
-- LIGHT 1s UPDATE LOOP
-- =========================
task.spawn(function()
	while true do
		local now = os.clock()
		local ownerDisplay = getNearbyPlotOwner()

		-- update cooldowns
		for cmd, cd in pairs(COMMANDS) do
			local remaining = math.max(0, math.ceil(cd - (now - lastUsed[cmd])))
			local prefix = enabledCommands[cmd] and "â˜‘ " or "â˜ "
			cooldownLabels[cmd].Text = prefix..cmd..": "..remaining.."s"
		end

		-- update player buttons
		for plr, ownerTag in pairs(playerButtons) do
			local nameLabel = ownerTag.Parent:FindFirstChildOfClass("TextLabel")
			if nameLabel then
				local text = plr.Name.." ("..plr.DisplayName..")" -- base text

				-- owner tag
				if ownerDisplay and plr.DisplayName == ownerDisplay then
					ownerTag.Visible = true
				else
					ownerTag.Visible = false
				end

				-- stealing tag
				if isPlayerStealing(plr) then
					text ..= " ðŸ”´"
				end

				nameLabel.Text = text
			end
		end

		task.wait(1)
	end
end)
